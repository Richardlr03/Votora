{% extends "base.html" %}

{% block content %}
<div class="container py-4" style="max-width: 700px;">
  {% if invalid %}
    <div class="d-md-none card border-0 shadow-sm text-center py-5 px-4">
      <div class="mx-auto mb-3" style="width: 56px; height: 56px;">
        <div class="rounded-circle bg-light d-flex align-items-center justify-content-center border">
          <i class="bi bi-exclamation-octagon text-danger" style="font-size: 1.25rem;"></i>
        </div>
      </div>
      <h1 class="h5 mb-2">Invalid voting link</h1>
      <p class="text-muted small mb-3">This voting code is not recognized or the link has expired.</p>
      <a href="/" class="btn btn-outline-secondary btn-sm">Return Home</a>
    </div>
  {% else %}
    <div class="d-md-none mb-3">
      <a href="{{ url_for('voter_dashboard', code=voter.code) }}" class="btn btn-outline-secondary w-100">
        <i class="bi bi-arrow-left me-1"></i> Back to all motions
      </a>
    </div>

    <div class="d-md-none card border-0 shadow-sm rounded-4 mb-3">
      <div class="card-body p-3">
        <div class="d-flex align-items-center gap-2 mb-2">
          <span class="badge bg-primary-subtle text-primary border border-primary-subtle px-2">
            {{ motion.status|title }}
          </span>
          <span class="text-muted small">&middot; {{ motion.type|replace('_', ' ')|title }}</span>
        </div>
        <h1 class="h5 fw-bold mb-1">{{ motion.title }}</h1>
        <p class="text-muted small mb-0">
          <i class="bi bi-building me-1"></i> {{ meeting.title }}
          <span class="mx-2">|</span>
          <i class="bi bi-person me-1"></i> {{ voter.name }}
        </p>
      </div>
    </div>

    <div class="d-md-none card border-0 shadow-sm mb-3">
      <div class="card-body p-3">
        <form method="POST" action="{{ url_for('vote_motion', code=voter.code, motion_id=motion.id) }}">
          {% if motion.type == "PREFERENCE" %}
            <div class="mb-3">
              <h2 class="h6 fw-bold">Rank your preferences</h2>
              <p class="text-muted small mb-0">Enter numbers (1 = highest preference).</p>
            </div>

            <div class="vstack gap-2">
              {% for opt in motion.options %}
                {% set existing_rank = preference_ranks.get(opt.id) if preference_ranks else '' %}
                <div class="d-flex align-items-center justify-content-between gap-2 border rounded-3 p-2">
                  <div class="fw-medium">{{ opt.text }}</div>
                  <input
                    type="number"
                    class="form-control form-control-sm text-center fw-bold border-primary-subtle"
                    name="opt_{{ opt.id }}_rank"
                    min="1"
                    max="{{ motion.options|length }}"
                    value="{{ existing_rank }}"
                    placeholder="—"
                    style="width: 70px;"
                  >
                </div>
              {% endfor %}
            </div>
          {% elif motion.type == "SCORE" %}
            <div class="mb-3">
              <h2 class="h6 fw-bold">Score each candidate</h2>
              <p class="text-muted small mb-0">
                Assign a score from 0 to {{ motion.score_max or 10 }} for each candidate.
              </p>
            </div>

            <div class="vstack gap-2">
              {% for opt in motion.options %}
                {% set existing_score = score_values.get(opt.id) if score_values else '' %}
                <div class="d-flex align-items-center justify-content-between gap-2 border rounded-3 p-2">
                  <div class="fw-medium">{{ opt.text }}</div>
                  <input
                    type="number"
                    class="form-control form-control-sm text-center fw-bold border-primary-subtle"
                    name="opt_{{ opt.id }}_score"
                    min="0"
                    max="{{ motion.score_max or 10 }}"
                    step="0.1"
                    value="{{ existing_score }}"
                    placeholder="0"
                    style="width: 90px;"
                  >
                </div>
              {% endfor %}
            </div>
          {% elif motion.type == "CUMULATIVE" %}
            <div class="mb-3">
              <h2 class="h6 fw-bold">Distribute your budget</h2>
              <p class="text-muted small mb-0">
                You must allocate exactly {{ motion.budget_points or 0 }} points across all candidates.
              </p>
            </div>

            <div class="vstack gap-2">
              {% for opt in motion.options %}
                {% set existing_points = cumulative_values.get(opt.id) if cumulative_values else '' %}
                <div class="d-flex align-items-center justify-content-between gap-2 border rounded-3 p-2">
                  <div class="fw-medium">{{ opt.text }}</div>
                  <input
                    type="number"
                    class="form-control form-control-sm text-center fw-bold border-primary-subtle cumulative-points-input"
                    name="opt_{{ opt.id }}_points"
                    min="0"
                    step="0.1"
                    value="{{ existing_points }}"
                    placeholder="0"
                    style="width: 90px;"
                  >
                </div>
              {% endfor %}
            </div>

            <div class="py-2 px-3 mt-3 rounded-3 bg-info-subtle border border-info-subtle" id="totalPointsMobile">
              Total allocated: <strong><span id="totalPointsMobileValue">0</span></strong> points
            </div>
          {% else %}
            <div class="mb-3">
              <h2 class="h6 fw-bold">
                {% if motion.type == "YES_NO" %}Cast your vote{% else %}Select one candidate{% endif %}
              </h2>
            </div>

            <div class="d-grid gap-2">
              {% for opt in motion.options %}
                <input
                  type="radio"
                  class="btn-check"
                  name="option"
                  id="opt_m_{{ opt.id }}"
                  value="{{ opt.id }}"
                  {% if simple_vote and simple_vote.option_id == opt.id %}checked{% endif %}
                  required
                >
                <label class="btn btn-outline-primary text-start p-3 d-flex align-items-center justify-content-between" for="opt_m_{{ opt.id }}">
                  <span class="fw-medium">{{ opt.text }}</span>
                  <i class="bi bi-check-circle-fill check-icon"></i>
                </label>
              {% endfor %}
            </div>
          {% endif %}

          <hr class="my-3 border-light">

          <div class="d-grid gap-2">
            <button type="submit" class="btn btn-primary w-100">
              <i class="bi bi-send me-2"></i>Submit Vote
            </button>
            <a href="{{ url_for('voter_dashboard', code=voter.code) }}" class="btn btn-outline-secondary w-100">
              Cancel
            </a>
          </div>
        </form>
      </div>
    </div>

    <div class="d-md-none text-center">
      <p class="text-muted small mb-0">
        <i class="bi bi-lock me-1"></i> Your vote is encrypted and stored securely.
      </p>
    </div>
  {% endif %}

  <div class="d-none d-md-block">
  {% if invalid %}
    <div class="card border-0 shadow-sm text-center py-5 px-4">
      <div class="mx-auto mb-3" style="width: 64px; height: 64px;">
        <div class="rounded-circle bg-light d-flex align-items-center justify-content-center border">
          <i class="bi bi-exclamation-octagon text-danger" style="font-size: 1.5rem;"></i>
        </div>
      </div>
      <h1 class="h4 mb-2">Invalid voting link</h1>
      <p class="text-muted mb-4">This voting code is not recognized or the link has expired.</p>
      <a href="/" class="btn btn-outline-secondary btn-sm">Return Home</a>
    </div>
  {% else %}

    <nav class="mb-4">
      <a href="{{ url_for('voter_dashboard', code=voter.code) }}" class="text-decoration-none text-muted small hover-primary">
        <i class="bi bi-arrow-left me-1"></i> Back to all motions
      </a>
    </nav>

    <header class="mb-4">
      <div class="d-flex align-items-center gap-2 mb-2">
        <span class="badge bg-primary-subtle text-primary border border-primary-subtle px-2">
          {{ motion.status|title }}
        </span>
        <span class="text-muted small">&middot; {{ motion.type|replace('_', ' ')|title }}</span>
      </div>
      <h1 class="h3 fw-bold mb-1">{{ motion.title }}</h1>
      <p class="text-muted small mb-0">
        <i class="bi bi-building me-1"></i> {{ meeting.title }} 
        <span class="mx-2">|</span>
        <i class="bi bi-person me-1"></i> {{ voter.name }}
      </p>
    </header>

    <div class="card border-0 shadow-sm mb-4">
      <div class="card-body p-3 p-md-4">
        <form method="POST" action="{{ url_for('vote_motion', code=voter.code, motion_id=motion.id) }}">
          
          {% if motion.type == "PREFERENCE" %}
            <div class="mb-3">
              <h2 class="h6 fw-bold">Rank your preferences</h2>
              <p class="text-muted small">Enter numbers (1 = highest preference).</p>
            </div>

            <div class="table-responsive">
              <table class="table table-hover align-middle">
                <thead class="table-light">
                  <tr class="small text-uppercase text-muted">
                    <th>Candidate / Option</th>
                    <th style="width: 100px;" class="text-center">Rank</th>
                  </tr>
                </thead>
                <tbody>
                  {% for opt in motion.options %}
                    {% set existing_rank = preference_ranks.get(opt.id) if preference_ranks else '' %}
                    <tr>
                      <td class="fw-medium text-dark">{{ opt.text }}</td>
                      <td class="text-center">
                        <input
                          type="number"
                          class="form-control form-control-sm text-center fw-bold border-primary-subtle"
                          name="opt_{{ opt.id }}_rank"
                          min="1"
                          max="{{ motion.options|length }}"
                          value="{{ existing_rank }}"
                          placeholder="—"
                        >
                      </td>
                    </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>

          {% elif motion.type == "SCORE" %}
            <div class="mb-4">
              <h2 class="h6 fw-bold">Score each candidate</h2>
              <p class="text-muted small mb-0">
                Assign a score from 0 to {{ motion.score_max or 10 }} for each candidate.
              </p>
            </div>

            <div class="table-responsive">
              <table class="table table-hover align-middle">
                <thead class="table-light">
                  <tr class="small text-uppercase text-muted">
                    <th>Candidate / Option</th>
                    <th style="width: 120px;" class="text-center">Score</th>
                  </tr>
                </thead>
                <tbody>
                  {% for opt in motion.options %}
                    {% set existing_score = score_values.get(opt.id) if score_values else '' %}
                    <tr>
                      <td class="fw-medium text-dark">{{ opt.text }}</td>
                      <td class="text-center">
                        <input
                          type="number"
                          class="form-control form-control-sm text-center fw-bold border-primary-subtle"
                          name="opt_{{ opt.id }}_score"
                          min="0"
                          max="{{ motion.score_max or 10 }}"
                          step="0.1"
                          value="{{ existing_score }}"
                          placeholder="0"
                        >
                      </td>
                    </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
          {% elif motion.type == "CUMULATIVE" %}
            <div class="mb-4">
              <h2 class="h6 fw-bold">Distribute your budget</h2>
              <p class="text-muted small mb-0">
                You must allocate exactly {{ motion.budget_points or 0 }} points across all candidates.
              </p>
            </div>

            <div class="table-responsive">
              <table class="table table-hover align-middle">
                <thead class="table-light">
                  <tr class="small text-uppercase text-muted">
                    <th>Candidate / Option</th>
                    <th style="width: 120px;" class="text-center">Points</th>
                  </tr>
                </thead>
                <tbody>
                  {% for opt in motion.options %}
                    {% set existing_points = cumulative_values.get(opt.id) if cumulative_values else '' %}
                    <tr>
                      <td class="fw-medium text-dark">{{ opt.text }}</td>
                      <td class="text-center">
                        <input
                          type="number"
                          class="form-control form-control-sm text-center fw-bold border-primary-subtle cumulative-points-input"
                          name="opt_{{ opt.id }}_points"
                          min="0"
                          step="0.1"
                          value="{{ existing_points }}"
                          placeholder="0"
                        >
                      </td>
                    </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>

            <div class="d-flex justify-content-between align-items-center py-2 px-3 mt-3 rounded-3 bg-info-subtle border border-info-subtle" id="totalPointsDesktop">
              <span class="small text-muted">Total allocated</span>
              <strong class="me-4"><span id="totalPointsDesktopValue">0</span></strong>
            </div>
          {% else %}
            <div class="mb-4">
              <h2 class="h6 fw-bold">
                {% if motion.type == "YES_NO" %}Cast your vote{% else %}Select one candidate{% endif %}
              </h2>
            </div>

            <div class="d-grid gap-2">
              {% for opt in motion.options %}
                <input 
                  type="radio" 
                  class="btn-check" 
                  name="option" 
                  id="opt_{{ opt.id }}" 
                  value="{{ opt.id }}" 
                  {% if simple_vote and simple_vote.option_id == opt.id %}checked{% endif %}
                  required
                >
                <label class="btn btn-outline-primary text-start p-3 d-flex align-items-center justify-content-between" for="opt_{{ opt.id }}">
                  <span class="fw-medium">{{ opt.text }}</span>
                  <i class="bi bi-check-circle-fill check-icon"></i>
                </label>
              {% endfor %}
            </div>
          {% endif %}

          <hr class="my-4 border-light">

          <div class="d-flex flex-column flex-md-row gap-2">
            <button type="submit" class="btn btn-primary px-4">
              <i class="bi bi-send me-2"></i>Submit Vote
            </button>
            <a href="{{ url_for('voter_dashboard', code=voter.code) }}" class="btn btn-outline-secondary px-4">
              Cancel
            </a>
          </div>
        </form>
      </div>
    </div>

    <div class="text-center">
      <p class="text-muted small">
        <i class="bi bi-lock me-1"></i> Your vote is encrypted and stored securely.
      </p>
    </div>
  {% endif %}
  </div>
</div>

<style>
  /* Button Selection Logic */
  .btn-check:checked + .btn-outline-primary {
    background-color: var(--bs-primary-bg-subtle);
    border-color: var(--bs-primary);
    color: var(--bs-primary-text-emphasis);
  }
  
  .btn-check + .btn-outline-primary .check-icon {
    opacity: 0;
    transition: opacity 0.2s;
  }

  .btn-check:checked + .btn-outline-primary .check-icon {
    opacity: 1;
  }

  .hover-primary:hover {
    color: var(--bs-primary) !important;
  }

  /* Focus styling for number inputs */
  input[type="number"]:focus {
    box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.15);
    border-color: #0d6efd;
  }
</style>

<script>
  (function initCumulativeBudget() {
    const inputs = document.querySelectorAll(".cumulative-points-input");
    if (!inputs.length) return;

    const mobileValue = document.getElementById("totalPointsMobileValue");
    const desktopValue = document.getElementById("totalPointsDesktopValue");

    function readValue(input) {
      const raw = (input.value || "").trim();
      if (raw === "") return 0;
      const num = Number(raw);
      return Number.isFinite(num) ? num : 0;
    }

    function updateTotal() {
      let total = 0;
      inputs.forEach((input) => {
        if (input.offsetParent === null) return;
        total += readValue(input);
      });
      const display = Number.isFinite(total) ? total.toFixed(1) : "0.0";

      if (mobileValue) mobileValue.textContent = display;
      if (desktopValue) desktopValue.textContent = display;
    }

    inputs.forEach((input) => {
      input.addEventListener("input", updateTotal);
    });

    updateTotal();
  })();
</script>
{% endblock %}
