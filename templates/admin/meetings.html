{% extends "base.html" %}
{% from "macros/meeting_schedule.html" import meeting_date_text, meeting_time_range_text %}

{% block content %}
<div class="container py-2">

    <div class="d-flex flex-column flex-md-row justify-content-between align-items-md-center gap-3 mb-3">
        <div>
            <h1 class="h3 mb-1 fw-bold">Admin · Meetings</h1>
            <p class="text-muted mb-0 small">Create, browse, and manage meetings.</p>
        </div>

        <button type="button" class="btn btn-primary fw-bold shadow-sm py-2 px-4 w-sm-100" 
                data-bs-toggle="modal" data-bs-target="#createMeetingModal">
            <i class="bi bi-plus-lg me-1"></i> Create New Meeting
        </button>
    </div>

    <div class="d-flex flex-column flex-md-row justify-content-between align-items-md-center gap-3 mb-3">
        <div class="input-group shadow-sm rounded-3 overflow-hidden" style="max-width: 420px;">
            <span class="input-group-text bg-white border-end-0">
                <i class="bi bi-search text-muted"></i>
            </span>
            <input id="meetingSearch" type="text" class="form-control border-start-0 ps-0" 
                   placeholder="Search by title or description…">
        </div>
        <small class="text-muted d-none d-md-block">
            Click a meeting title to manage details.
        </small>
    </div>

    <div id="meetingContent">
        {% if meetings %}
            <div class="d-md-none row g-3" id="meetingCards">
                {% for m in meetings %}
                <div class="col-12 meeting-row" data-searchable="{{ m.title }} {{ m.description }}">
                    <div class="card border-0 shadow-sm rounded-4">
                        <div class="card-body p-3">
                            <h3 class="h6 fw-bold mb-1">
                                <a class="text-decoration-none text-dark" href="{{ url_for('meeting_detail', meeting_id=m.id) }}">
                                    {{ m.title }}
                                </a>
                            </h3>
                            <p class="text-muted x-small mb-3">
                                {% if m.meeting_date %}
                                    {{ meeting_date_text(m, "%d/%m/%Y") }}
                                {% else %}
                                    —
                                {% endif %}
                                {% if m.start_time or m.end_time %}
                                    <span class="mx-1">•</span>
                                    {{ meeting_time_range_text(m, "--:--") }}
                                {% endif %}
                            </p>
                            <div class="d-flex gap-2">
                                <a href="{{ url_for('meeting_detail', meeting_id=m.id) }}" class="btn btn-sm btn-outline-primary flex-grow-1 fw-bold">Manage</a>
                                <button class="btn btn-sm btn-outline-secondary edit-meeting-btn"
                                        data-id="{{ m.id }}"
                                        data-title="{{ m.title }}"
                                        data-description="{{ m.description or '' }}"
                                        data-meeting-date="{{ m.meeting_date or '' }}"
                                        data-start-time="{{ m.start_time or '' }}"
                                        data-end-time="{{ m.end_time or '' }}"
                                        data-url="{{ url_for('update_meeting', meeting_id=m.id) }}"
                                        title="Edit">
                                    <i class="bi bi-pencil"></i>
                                </button>
                                <button class="btn btn-sm btn-outline-danger px-3 delete-meeting-btn" 
                                        data-id="{{ m.id }}" data-title="{{ m.title }}" 
                                        data-url="{{ url_for('delete_meeting', meeting_id=m.id) }}">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>

            <div class="d-none d-md-block card shadow-sm border-0 rounded-4 overflow-hidden">
                <div class="table-responsive">
                    <table class="table align-middle mb-0">
                    <thead class="table-light">
                        <tr>
                        <th class="ps-4">Meeting</th>
                        <th style="width: 160px;">Date</th>
                        <th style="width: 170px;">Time</th>
                        <th class="text-end pe-5" style="width: 240px;">Actions</th>
                        </tr>
                    </thead>

                    <tbody id="meetingTableBody">
                        {% for m in meetings %}
                        <tr class="meeting-row" data-searchable="{{ m.title }} {{ m.description }}">
                        <!-- Meeting (Title + Description) -->
                        <td class="ps-4">
                            <div class="fw-semibold">
                            <a class="text-decoration-none link-primary"
                                href="{{ url_for('meeting_detail', meeting_id=m.id) }}">
                                {{ m.title }}
                            </a>
                            </div>
                            {% if m.description %}
                            <div class="text-muted small text-truncate-2">
                                {{ m.description }}
                            </div>
                            {% else %}
                            <div class="text-muted small">—</div>
                            {% endif %}
                        </td>

                        <!-- Date -->
                        <td class="text-muted small">
                            {% if m.meeting_date %}
                            {{ meeting_date_text(m, "%d %b %Y") }}
                            {% else %}
                            —
                            {% endif %}
                        </td>

                        <!-- Time -->
                        <td class="text-muted small">
                            {% if m.start_time or m.end_time %}
                            {{ meeting_time_range_text(m, "--:--") }}
                            {% else %}
                            —
                            {% endif %}
                        </td>

                        <!-- Actions -->
                        <td class="text-end pe-4">
                            <div class="d-flex justify-content-end gap-2">
                            <a href="{{ url_for('meeting_detail', meeting_id=m.id) }}"
                                class="btn btn-sm btn-outline-primary">
                                Manage
                            </a>

                            <button class="btn btn-sm btn-outline-secondary edit-meeting-btn"
                                    data-id="{{ m.id }}"
                                    data-title="{{ m.title }}"
                                    data-description="{{ m.description or '' }}"
                                    data-meeting-date="{{ m.meeting_date or '' }}"
                                    data-start-time="{{ m.start_time or '' }}"
                                    data-end-time="{{ m.end_time or '' }}"
                                    data-url="{{ url_for('update_meeting', meeting_id=m.id) }}">
                                Edit
                            </button>

                            <button class="btn btn-sm btn-outline-danger delete-meeting-btn"
                                    data-id="{{ m.id }}"
                                    data-title="{{ m.title }}"
                                    data-url="{{ url_for('delete_meeting', meeting_id=m.id) }}">
                                Delete
                            </button>
                            </div>
                        </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                    </table>
                </div>
            </div>


            <div id="noResults" class="text-center py-5 d-none">
                <i class="bi bi-search fs-1 text-muted mb-2 d-block"></i>
                <p class="text-muted">No meetings match your search.</p>
            </div>

        {% else %}
            <div class="text-center py-5 vp-surface">
                <i class="bi bi-calendar2-plus text-primary display-4 mb-3 d-block"></i>
                <h2 class="h5 fw-bold">No meetings yet</h2>
                <p class="text-muted small mb-4">Create your first meeting to start adding motions.</p>
                <button class="btn btn-primary px-4 py-2 fw-bold" data-bs-toggle="modal" data-bs-target="#createMeetingModal">Get Started</button>
            </div>
        {% endif %}
    </div>
</div>

<div class="modal fade" id="createMeetingModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content border-0 shadow-lg rounded-4">
            <div class="modal-header border-0 pb-0">
                <h5 class="fw-bold">New Meeting</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="createMeetingForm" method="POST" action="{{ url_for('create_meeting') }}" data-action="{{ url_for('create_meeting') }}">
                <div class="modal-body">
                    <div class="alert alert-danger d-none" id="createMeetingError"></div>
                    <div class="mb-3">
                        <label class="form-label small fw-bold">Meeting Title</label>
                        <input type="text" class="form-control" name="title" required>
                    </div>
                    <div class="mb-2">
                        <label class="form-label small fw-bold">Description (Optional)</label>
                        <textarea class="form-control" name="description" rows="3"></textarea>
                    </div>
                    <div class="row g-2">
                        <div class="col-12 col-md-4">
                            <label class="form-label small fw-bold">Meeting Date</label>
                            <input type="date" class="form-control" name="meeting_date">
                        </div>
                        <div class="col-6 col-md-4">
                            <label class="form-label small fw-bold">Start Time</label>
                            <input type="time" class="form-control" name="start_time">
                        </div>
                        <div class="col-6 col-md-4">
                            <label class="form-label small fw-bold">End Time</label>
                            <input type="time" class="form-control" name="end_time">
                        </div>
                    </div>
                </div>
                <div class="modal-footer border-0">
                    <button type="button" class="btn btn-light px-4" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary px-4 shadow-sm" id="createMeetingSubmit">Create Meeting</button>
                </div>
            </form>
        </div>
    </div>
</div>

<div class="modal fade" id="editMeetingModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content border-0 shadow-lg rounded-4">
            <div class="modal-header border-0 pb-0">
                <h5 class="fw-bold">Edit Meeting</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="editMeetingForm" method="POST">
                <div class="modal-body">
                    <div class="alert alert-danger d-none" id="editMeetingError"></div>
                    <div class="mb-3">
                        <label class="form-label small fw-bold">Meeting Title</label>
                        <input type="text" class="form-control" name="title" id="editMeetingTitle" required>
                    </div>
                    <div class="mb-2">
                        <label class="form-label small fw-bold">Description (Optional)</label>
                        <textarea class="form-control" name="description" id="editMeetingDescription" rows="3"></textarea>
                    </div>
                    <div class="row g-2">
                        <div class="col-12 col-md-4">
                            <label class="form-label small fw-bold">Meeting Date</label>
                            <input type="date" class="form-control" name="meeting_date" id="editMeetingDate">
                        </div>
                        <div class="col-6 col-md-4">
                            <label class="form-label small fw-bold">Start Time</label>
                            <input type="time" class="form-control" name="start_time" id="editStartTime">
                        </div>
                        <div class="col-6 col-md-4">
                            <label class="form-label small fw-bold">End Time</label>
                            <input type="time" class="form-control" name="end_time" id="editEndTime">
                        </div>
                    </div>
                </div>
                <div class="modal-footer border-0">
                    <button type="button" class="btn btn-light px-4" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary px-4 shadow-sm" id="editMeetingSubmit">Save Changes</button>
                </div>
            </form>
        </div>
    </div>
</div>

<div class="modal fade" id="deleteConfirmModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered px-3">
        <div class="modal-content border-0 shadow-lg rounded-4">
            <div class="modal-header border-0 pb-0">
                <h5 class="fw-bold text-danger"><i class="bi bi-exclamation-triangle me-2"></i>Confirm Delete</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p class="mb-0">Are you sure you want to delete <strong id="deleteTargetTitle"></strong>?</p>
                <p class="small text-muted mt-2">This action will permanently remove all motions, voters, and cast votes. This cannot be undone.</p>
            </div>
            <div class="modal-footer border-0 pt-0">
                <button type="button" class="btn btn-light flex-grow-1 py-2" data-bs-dismiss="modal">Cancel</button>
                <button type="button" id="confirmDeleteSubmit" class="btn btn-danger flex-grow-1 py-2 shadow-sm">Delete Meeting</button>
            </div>
        </div>
    </div>
</div>

<style>
    /* Styling for both views */
    .text-truncate-2 {
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
        overflow: hidden;
    }
    .x-small { font-size: 0.75rem; }

    @media (max-width: 576px) {
        .w-sm-100 { width: 100% !important; }
        .container { padding-left: 15px; padding-right: 15px; }
    }
</style>

<script>
    // Search logic handles both Cards and Table rows
    document.getElementById("meetingSearch").addEventListener("input", function () {
        const q = this.value.trim().toLowerCase();
        const rows = document.querySelectorAll(".meeting-row");
        let visibleCount = 0;

        rows.forEach(row => {
            const searchable = row.getAttribute("data-searchable").toLowerCase();
            const match = searchable.includes(q);
            row.classList.toggle("d-none", !match);
            if (match) visibleCount++;
        });
        document.getElementById("noResults").classList.toggle("d-none", visibleCount !== 0);
    });

    document.addEventListener("DOMContentLoaded", function () {
        const createMeetingModalEl = document.getElementById("createMeetingModal");
        const createMeetingModal = new bootstrap.Modal(createMeetingModalEl);
        const createMeetingForm = document.getElementById("createMeetingForm");
        const createMeetingSubmit = document.getElementById("createMeetingSubmit");
        const createMeetingError = document.getElementById("createMeetingError");

        function setCreateMeetingLoading(isLoading) {
            createMeetingSubmit.disabled = isLoading;
            createMeetingSubmit.innerHTML = isLoading
                ? '<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>Creating...'
                : "Create Meeting";
        }

        createMeetingForm.addEventListener("submit", async (event) => {
            event.preventDefault();
            createMeetingError.classList.add("d-none");
            setCreateMeetingLoading(true);

            const formData = new FormData(createMeetingForm);
            try {
                const response = await fetch(createMeetingForm.dataset.action, {
                    method: "POST",
                    body: formData,
                    headers: { "X-Requested-With": "XMLHttpRequest" },
                });

                if (!response.ok) {
                    let message = "Failed to create meeting.";
                    try {
                        const data = await response.json();
                        if (data && data.error) message = data.error;
                    } catch (err) { /* ignore parse errors */ }
                    throw new Error(message);
                }

                createMeetingModal.hide();
                try {
                    sessionStorage.setItem("vpFlash", JSON.stringify({
                        type: "success",
                        message: "Meeting created successfully."
                    }));
                } catch (e) { /* ignore */ }
                window.location.reload();
            } catch (err) {
                createMeetingError.textContent = err.message;
                createMeetingError.classList.remove("d-none");
            } finally {
                setCreateMeetingLoading(false);
            }
        });

        createMeetingModalEl.addEventListener("hidden.bs.modal", () => {
            createMeetingForm.reset();
            createMeetingError.classList.add("d-none");
            setCreateMeetingLoading(false);
        });

        const deleteModalEl = document.getElementById('deleteConfirmModal');
        const deleteModal = new bootstrap.Modal(deleteModalEl);
        const confirmDeleteBtn = document.getElementById('confirmDeleteSubmit');
        const deleteTargetTitle = document.getElementById('deleteTargetTitle');
        
        let currentDeleteUrl = "";
        let currentDeleteBtn = null;

        // Triggered when any "Delete" button in the list is clicked
        document.querySelectorAll(".delete-meeting-btn").forEach((btn) => {
            btn.addEventListener("click", () => {
                currentDeleteUrl = btn.dataset.url;
                currentDeleteBtn = btn;
                deleteTargetTitle.textContent = btn.dataset.title;
                deleteModal.show(); // Show the Bootstrap Modal instead of confirm()
            });
        });

        // Handle the final confirmation click inside the modal
        confirmDeleteBtn.addEventListener("click", async () => {
            confirmDeleteBtn.disabled = true;
            confirmDeleteBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Deleting...';

            try {
                const response = await fetch(currentDeleteUrl, {
                    method: "POST",
                    headers: { "X-Requested-With": "XMLHttpRequest" },
                });

                if (!response.ok) throw new Error("Failed to delete meeting.");

                deleteModal.hide();
                try {
                    sessionStorage.setItem("vpFlash", JSON.stringify({
                        type: "success",
                        message: "Meeting deleted successfully."
                    }));
                } catch (e) { /* ignore */ }
                window.location.reload(); // Refresh the list
            } catch (err) {
                alert(err.message);
                confirmDeleteBtn.disabled = false;
                confirmDeleteBtn.innerHTML = "Delete Meeting";
            }
        });

        const editMeetingModalEl = document.getElementById("editMeetingModal");
        const editMeetingModal = new bootstrap.Modal(editMeetingModalEl);
        const editMeetingForm = document.getElementById("editMeetingForm");
        const editMeetingError = document.getElementById("editMeetingError");

        document.querySelectorAll(".edit-meeting-btn").forEach((btn) => {
            btn.addEventListener("click", () => {
                editMeetingForm.action = btn.dataset.url;
                document.getElementById("editMeetingTitle").value = btn.dataset.title || "";
                document.getElementById("editMeetingDescription").value = btn.dataset.description || "";
                document.getElementById("editMeetingDate").value = btn.dataset.meetingDate || "";
                document.getElementById("editStartTime").value = btn.dataset.startTime || "";
                document.getElementById("editEndTime").value = btn.dataset.endTime || "";
                editMeetingError.classList.add("d-none");
                editMeetingModal.show();
            });
        });

        editMeetingForm.addEventListener("submit", async (event) => {
            event.preventDefault();
            editMeetingError.classList.add("d-none");
            const formData = new FormData(editMeetingForm);
            try {
                const response = await fetch(editMeetingForm.action, {
                    method: "POST",
                    body: formData,
                    headers: { "X-Requested-With": "XMLHttpRequest" },
                });
                if (!response.ok) {
                    let message = "Failed to update meeting.";
                    try {
                        const data = await response.json();
                        if (data && data.error) message = data.error;
                    } catch (err) { /* ignore */ }
                    throw new Error(message);
                }
                editMeetingModal.hide();
                window.location.reload();
            } catch (err) {
                editMeetingError.textContent = err.message;
                editMeetingError.classList.remove("d-none");
                if (typeof showFlashModal === "function") {
                    showFlashModal("danger", err.message);
                }
            }
        });
    });

    // Existing Fetch/Delete/Modal logic stays same as app.py uses standard routes
</script>
{% endblock %}

