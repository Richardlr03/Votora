{% extends "base.html" %}

{% block content %}
  <div class="py-2">

    <!-- Mobile layout -->
    <div class="d-lg-none">
      <div class="mb-3">
        <a href="{{ url_for('admin_meetings') }}" class="btn btn-outline-secondary w-100">
          <i class="bi bi-arrow-left me-1"></i> Back to Meetings
        </a>
      </div>

      <div class="card border-0 shadow-sm rounded-4 mb-3">
        <div class="card-body p-3">
          <div class="d-flex align-items-start justify-content-between gap-2">
            <div>
              <h1 class="h5 mb-1">{{ meeting.title }}</h1>
              <div class="text-muted small">
                <i class="bi bi-shield-lock me-1"></i> Admin view
              </div>
            </div>
            <button
              class="btn btn-link btn-sm p-0 text-muted"
              data-bs-toggle="modal"
              data-bs-target="#editMeetingModal"
              title="Edit Meeting Details">
              <i class="bi bi-pencil"></i>
            </button>
          </div>

          <hr class="my-3">

          {% if meeting.description %}
            <p class="mb-0">{{ meeting.description }}</p>
          {% else %}
            <p class="text-muted mb-0"><em>No description provided.</em></p>
          {% endif %}
        </div>
      </div>

      <div class="d-grid gap-2 mb-3">
        <a href="{{ url_for('meeting_votes', meeting_id=meeting.id) }}" class="btn btn-outline-secondary">
          <i class="bi bi-list-check me-1"></i> Detailed Votes
        </a>
        <a href="{{ url_for('meeting_results', meeting_id=meeting.id) }}" class="btn btn-primary">
          <i class="bi bi-bar-chart me-1"></i> View Results
        </a>
      </div>

      <div class="card border-0 shadow-sm rounded-4 mb-3">
        <div class="card-body p-3">
          <div class="d-flex align-items-center justify-content-between mb-2">
            <button
              class="btn btn-link text-decoration-none p-0 d-flex align-items-center gap-2"
              type="button"
              data-bs-toggle="collapse"
              data-bs-target="#mobileMotionsCollapse"
              aria-expanded="false"
              aria-controls="mobileMotionsCollapse">
              <span class="fw-semibold">Motions</span>
              <span class="text-muted small">
                {% if meeting.motions %}Total: {{ meeting.motions|length }}{% else %}No motions yet{% endif %}
              </span>
              <i class="bi bi-chevron-down small"></i>
            </button>
            <button
              type="button"
              class="btn btn-sm btn-primary"
              data-bs-toggle="modal"
              data-bs-target="#addMotionModal"
            >
              <i class="bi bi-plus-lg me-1"></i> Add
            </button>
          </div>

          <div class="collapse" id="mobileMotionsCollapse">
            {% if meeting.motions %}
              <div class="list-group list-group-flush">
                {% for motion in meeting.motions %}
                  <div class="list-group-item px-0 py-3">
                    <div class="fw-semibold mb-1">{{ motion.title }}</div>
                    <div class="d-flex align-items-start justify-content-between gap-2">
                      <div>
                        <div class="d-flex flex-wrap gap-2 align-items-center mb-2">
                          <span class="badge text-bg-light border">
                            <i class="bi bi-tag me-1"></i>{{ motion.type }}
                          </span>
                        </div>
                        <div class="d-flex flex-wrap gap-2 align-items-center mb-2">
                          {% set status_cls =
                            'success' if motion.status in ['OPEN', 'APPROVED', 'PASSED']
                            else 'secondary' if motion.status in ['DRAFT', 'PENDING']
                            else 'danger' if motion.status in ['REJECTED', 'FAILED', 'CLOSED']
                            else 'info'
                          %}
                          <span class="badge text-bg-{{ status_cls }}">
                            {{ motion.status }}
                          </span>
                        </div>
                      </div>

                      <div class="d-flex gap-2">
                        <button
                            class="btn btn-outline-primary btn-sm"
                            data-bs-toggle="modal"
                            data-bs-target="#statusModal{{ motion.id }}"
                            title="Update Status">
                            <i class="bi bi-arrow-repeat"></i>
                        </button>
                        <button type="button"
                                class="btn btn-sm btn-outline-secondary edit-motion-btn"
                                data-motion-id="{{ motion.id }}"
                                data-motion-title="{{ motion.title }}"
                                data-motion-type="{{ motion.type }}"
                                data-motion-status="{{ motion.status }}"
                                data-motion-winners="{{ motion.num_winners or '' }}"
                                data-motion-threshold="{{ motion.approved_threshold_pct if motion.approved_threshold_pct is not none else '' }}"
                                data-motion-score-max="{{ motion.score_max or '' }}"
                                data-motion-options="{% for c in motion.options %}{{ c.text }}{{ '\n' if not loop.last }}{% endfor %}"
                                title="Edit Motion">
                          <i class="bi bi-pencil"></i>
                        </button>
                        <button type="button"
                                class="btn btn-sm btn-outline-danger delete-motion-btn"
                                data-motion-id="{{ motion.id }}"
                                data-motion-title="{{ motion.title }}"
                                title="Delete Motion">
                          <i class="bi bi-trash"></i>
                        </button>
                      </div>
                    </div>
                  </div>

                {% endfor %}
              </div>
            {% else %}
              <div class="text-center py-4">
                <div class="mb-2 text-muted">
                  <i class="bi bi-file-earmark-plus" style="font-size: 2rem;"></i>
                </div>
                <h3 class="h6 mb-1">No motions added</h3>
                <p class="text-muted mb-0">Add a motion to start collecting votes.</p>
              </div>
            {% endif %}
          </div>
        </div>
      </div>

      <div class="card border-0 shadow-sm rounded-4 mb-2">
        <div class="card-body p-3">
          <div class="d-flex align-items-center justify-content-between mb-2">
            <button
              class="btn btn-link text-decoration-none p-0 d-flex align-items-center gap-2"
              type="button"
              data-bs-toggle="collapse"
              data-bs-target="#mobileVotersCollapse"
              aria-expanded="false"
              aria-controls="mobileVotersCollapse">
              <span class="fw-semibold">Voters</span>
              <span class="text-muted small">
                {% if meeting.voters %}Total: {{ meeting.voters|length }}{% else %}No voters yet{% endif %}
              </span>
              <i class="bi bi-chevron-down small"></i>
            </button>
            <button
              type="button"
              class="btn btn-sm btn-primary"
              data-bs-toggle="modal"
              data-bs-target="#addVoterModal"
            >
              <i class="bi bi-plus-lg me-1"></i> Add
            </button>
          </div>

          <div class="collapse" id="mobileVotersCollapse">
            {% if meeting.voters %}
              <div class="list-group list-group-flush">
                {% for voter in meeting.voters %}
                  <div class="list-group-item px-0 py-3">
                    <div class="d-flex align-items-start justify-content-between gap-2">
                      <div>
                        <div class="fw-semibold">{{ voter.name }}</div>
                        <div class="text-muted small">
                          Code:
                          <span class="font-monospace">{{ voter.code }}</span>
                        </div>
                      </div>

                      <div class="d-flex gap-2 mt-1">
                        <button type="button"
                                class="btn btn-sm btn-outline-secondary copy-voter-link-btn"
                                data-voter-link="{{ url_for('voter_dashboard', code=voter.code, _external=True) }}"
                                title="Copy voter link">
                          <i class="bi bi-clipboard"></i>
                        </button>
                        <button type="button"
                                class="btn btn-sm btn-outline-secondary edit-voter-btn"
                                data-voter-id="{{ voter.id }}"
                                data-voter-name="{{ voter.name }}"
                                title="Edit Voter">
                          <i class="bi bi-pencil"></i>
                        </button>
                        <button type="button"
                                class="btn btn-sm btn-outline-danger delete-voter-btn"
                                data-voter-id="{{ voter.id }}"
                                data-voter-name="{{ voter.name }}"
                                title="Delete Voter">
                          <i class="bi bi-trash"></i>
                        </button>
                      </div>
                    </div>
                  </div>
                {% endfor %}
              </div>
            {% else %}
              <div class="text-center py-4">
                <div class="mb-2 text-muted">
                  <i class="bi bi-people" style="font-size: 2rem;"></i>
                </div>
                <h3 class="h6 mb-1">No voters added</h3>
                <p class="text-muted mb-0">Add voters so they can receive access codes.</p>
              </div>
            {% endif %}
          </div>
        </div>
      </div>
    </div>

    <!-- Top bar -->
    <div class="d-none d-lg-flex align-items-center justify-content-between flex-wrap gap-2 mb-3">
      <a href="{{ url_for('admin_meetings') }}" class="btn btn-sm btn-outline-secondary">
        <i class="bi bi-arrow-left me-1"></i> Back
      </a>

      <div class="d-flex gap-2">
        <a href="{{ url_for('meeting_votes', meeting_id=meeting.id) }}" class="btn btn-sm btn-outline-secondary">
          <i class="bi bi-list-check me-1"></i> Detailed Votes
        </a>
        <a href="{{ url_for('meeting_results', meeting_id=meeting.id) }}" class="btn btn-sm btn-primary">
          <i class="bi bi-bar-chart me-1"></i> View Results
        </a>
      </div>
    </div>

    <!-- Header card -->
    <div class="d-none d-lg-block card border-0 shadow-sm mb-4">
      <div class="card-body p-3 p-md-4">
        <div class="d-flex align-items-start justify-content-between gap-3 flex-wrap">
          <div class="d-flex align-items-center gap-3">
            <h1 class="h4 mb-1">{{ meeting.title }}</h1>
            <button 
              class="btn btn-link btn-sm p-0 text-muted" 
              data-bs-toggle="modal" 
              data-bs-target="#editMeetingModal" 
              title="Edit Meeting Details">
              <i class="bi bi-pencil me-1"></i>
            </button>
          </div>

          <div class="text-muted small">
            <i class="bi bi-shield-lock me-1"></i>
            Admin view
          </div>
        </div>

        <hr class="my-3">

        {% if meeting.description %}
          <p class="mb-0">{{ meeting.description }}</p>
        {% else %}
          <p class="text-muted mb-0"><em>No description provided.</em></p>
        {% endif %}
      </div>
    </div>

    <!-- Two columns -->
    <div class="d-none d-lg-flex row g-4">

      <!-- Motions -->
      <div class="col-lg-6">
        <div class="card border-0 shadow-sm h-100">
          <div class="card-header bg-white border-0 pt-3 pb-0 px-3 px-md-4">
            <div class="d-flex align-items-center justify-content-between">
              <div>
                <h2 class="h5 mb-0">Motions</h2>
                <div class="text-muted small">
                  {% if meeting.motions %}Total: {{ meeting.motions|length }}{% else %}No motions yet{% endif %}
                </div>
              </div>

              <button
                type="button"
                class="btn btn-sm btn-primary"
                data-bs-toggle="modal"
                data-bs-target="#addMotionModal"
              >
                <i class="bi bi-plus-lg me-1"></i> Add Motion
              </button>
            </div>
          </div>

          <div class="card-body p-3 p-md-4 scrollable-panel">
            {% if meeting.motions %}
              <div class="list-group list-group-flush">
                {% for motion in meeting.motions %}
                  <div class="list-group-item px-0 py-3">
                    <div class="d-flex align-items-center justify-content-between gap-2">
                      <div class="pe-2">
                        <div class="fw-semibold mb-1">{{ motion.title }}</div>
                        <div class="d-flex flex-wrap gap-2 align-items-center">
                          <span class="badge text-bg-light border">
                            <i class="bi bi-tag me-1"></i>{{ motion.type }}
                          </span>

                          {% set status_cls =
                            'success' if motion.status == 'OPEN'
                            else 'secondary' if motion.status == 'DRAFT'
                            else 'danger' if motion.status == 'CLOSED'
                            else 'info'
                          %}
                          <span class="badge text-bg-{{ status_cls }}">
                            {{ motion.status }}
                          </span>
                        </div>
                      </div>

                      <div class="d-flex gap-2">
                        <button 
                            class="btn btn-outline-primary btn-sm" 
                            data-bs-toggle="modal" 
                            data-bs-target="#statusModal{{ motion.id }}"
                            title="Update Status">
                            <i class="bi bi-arrow-repeat"></i>
                        </button>
                        <button type="button" 
                                class="btn btn-sm btn-outline-secondary edit-motion-btn" 
                                data-motion-id="{{ motion.id }}" 
                                data-motion-title="{{ motion.title }}"
                                data-motion-type="{{ motion.type }}"
                                data-motion-status="{{ motion.status }}"
                                data-motion-winners="{{ motion.num_winners or '' }}"
                                data-motion-threshold="{{ motion.approved_threshold_pct if motion.approved_threshold_pct is not none else '' }}"
                                data-motion-score-max="{{ motion.score_max or '' }}"
                                data-motion-options="{% for c in motion.options %}{{ c.text }}{{ '\n' if not loop.last }}{% endfor %}"
                                title="Edit Motion">    
                          <i class="bi bi-pencil"></i>
                        </button>
                        <button type="button" 
                                class="btn btn-sm btn-outline-danger delete-motion-btn" 
                                data-motion-id="{{ motion.id }}" 
                                data-motion-title="{{ motion.title }}"
                                title="Delete Motion">
                          <i class="bi bi-trash"></i>
                        </button>
                      </div>
                    </div>
                  </div>

                {% endfor %}
              </div>
            {% else %}
              <div class="text-center py-4">
                <div class="mb-2 text-muted">
                  <i class="bi bi-file-earmark-plus" style="font-size: 2rem;"></i>
                </div>
                <h3 class="h6 mb-1">No motions added</h3>
                <p class="text-muted mb-3">Add a motion to start collecting votes.</p>
              </div>
            {% endif %}
          </div>
        </div>
      </div>

      <!-- Voters -->
      <div class="col-lg-6">
        <div class="card border-0 shadow-sm h-100">
          <div class="card-header bg-white border-0 pt-3 pb-0 px-3 px-md-4">
            <div class="d-flex align-items-center justify-content-between">
              <div>
                <h2 class="h5 mb-0">Voters</h2>
                <div class="text-muted small">
                  {% if meeting.voters %}Total: {{ meeting.voters|length }}{% else %}No voters yet{% endif %}
                </div>
              </div>

              <button
                type="button"
                class="btn btn-sm btn-primary"
                data-bs-toggle="modal"
                data-bs-target="#addVoterModal"
              >
                <i class="bi bi-plus-lg me-1"></i> Add Voter
              </button>
            </div>
          </div>

          <div class="card-body p-3 p-md-4 scrollable-panel">
            {% if meeting.voters %}
              <div class="list-group list-group-flush">
                {% for voter in meeting.voters %}
                  <div class="list-group-item px-0 py-3">
                    <div class="d-flex align-items-center justify-content-between gap-2">
                      <div>
                        <div class="fw-semibold">{{ voter.name }}</div>
                        <div class="text-muted small">
                          Code:
                          <span class="font-monospace">{{ voter.code }}</span>
                        </div>
                      </div>

                      <div class="d-flex gap-2">
                        <button type="button" 
                                class="btn btn-sm btn-outline-secondary copy-voter-link-btn" 
                                data-voter-link="{{ url_for('voter_dashboard', code=voter.code, _external=True) }}"
                                title="Copy voter link">
                          <i class="bi bi-clipboard"></i>
                        </button>
                        <button type="button" 
                                class="btn btn-sm btn-outline-secondary edit-voter-btn" 
                                data-voter-id="{{ voter.id }}" 
                                data-voter-name="{{ voter.name }}"
                                title="Edit Voter">
                          <i class="bi bi-pencil"></i>
                        </button>
                        <button type="button" 
                                class="btn btn-sm btn-outline-danger delete-voter-btn" 
                                data-voter-id="{{ voter.id }}" 
                                data-voter-name="{{ voter.name }}"
                                title="Delete Voter">
                          <i class="bi bi-trash"></i>
                        </button>
                      </div>
                    </div>
                  </div>
                {% endfor %}
              </div>
            {% else %}
              <div class="text-center py-4">
                <div class="mb-2 text-muted">
                  <i class="bi bi-people" style="font-size: 2rem;"></i>
                </div>
                <h3 class="h6 mb-1">No voters added</h3>
                <p class="text-muted mb-3">Add voters so they can receive access codes.</p>
              </div>
            {% endif %}
          </div>
        </div>
      </div>
    </div>
  </div>

  {% if meeting.motions %}
    {% for motion in meeting.motions %}
      <!-- Update Motion Status Modal -->
      <div class="modal fade" id="statusModal{{ motion.id }}" tabindex="-1">
        <div class="modal-dialog modal-sm modal-dialog-centered">
            <div class="modal-content border-0 shadow" style="border-radius: 15px;">

                <div class="modal-header border-0 pb-0 d-flex justify-content-center position-relative">
                    <h5 class="modal-title fw-bold" id="statusModalLabel{{ motion.id }}">Update Status</h5>
                    <button type="button" class="btn-close position-absolute" data-bs-dismiss="modal" aria-label="Close"
                            style="top: 20px; right: 20px;"></button>
                </div>

                <form action="{{ url_for('update_motion_status', motion_id=motion.id) }}" method="POST">
                    <div class="modal-body p-4 pt-2 text-center">
                        <p class="small text-muted mb-4">Current: <b>{{ motion.status }}</b></p>

                        <select name="status" class="form-select bg-light border-0 py-2 mb-3">
                            <option value="DRAFT" {% if motion.status == 'DRAFT' %}selected{% endif %}>Draft</option>
                            <option value="OPEN" {% if motion.status == 'OPEN' %}selected{% endif %}>Open</option>
                            <option value="CLOSED" {% if motion.status == 'CLOSED' %}selected{% endif %}>Closed</option>
                        </select>

                        <button type="submit" class="btn btn-primary w-100 py-2 fw-semibold">Update</button>
                    </div>
                </form>
            </div>
        </div>
      </div>
    {% endfor %}
  {% endif %}

  <!-- Add Motion Modal -->
  <div class="modal fade" id="addMotionModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
      <div class="modal-content border-0 shadow">
        <div class="modal-header bg-light border-0">
          <h5 class="modal-title"><i class="bi bi-plus-square me-2"></i>Add Motion</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>

        <form
          id="addMotionForm"
          method="POST"
          action="{{ url_for('create_motion', meeting_id=meeting.id) }}"
          data-action="{{ url_for('create_motion', meeting_id=meeting.id) }}"
        >
          <div class="modal-body p-3 p-md-4">
            <div class="alert alert-danger d-none" id="addMotionError" role="alert"></div>

            <div class="mb-3">
              <label for="motionTitle" class="form-label">Motion Title</label>
              <input type="text" class="form-control" id="motionTitle" name="title" required>
            </div>

            <div class="mb-3">
              <label for="motionType" class="form-label">Motion Type</label>
              <select class="form-select" id="motionType" name="type" required>
                <option value="YES_NO">Yes / No / Abstain</option>
                <option value="FPTP">First-Past-The-Post (FPTP)</option>
                <option value="PREFERENCE">Preference voting (ranked, multiple winners)</option>
                <option value="SCORE">Score voting</option>
              </select>
            </div>

            <div class="mb-3" id="candidatesGroup">
              <label for="motionCandidates" class="form-label">
                Candidates (one per line)
              </label>
              <textarea
                class="form-control"
                id="motionCandidates"
                name="candidates"
                rows="4"
                placeholder="Alice&#10;Bob&#10;Charlie"
              ></textarea>
            </div>

            <div class="mb-3" id="numWinnersGroup">
              <label for="motionNumWinners" class="form-label">
                Number of winners
              </label>
              <input
                type="number"
                class="form-control"
                id="motionNumWinners"
                name="num_winners"
                min="1"
                placeholder="e.g. 1 or 2"
              >
            </div>

            <div class="mb-3" id="yesNoThresholdGroup">
              <label for="motionApprovedThreshold" class="form-label">
                Approved threshold (%)
              </label>
              <input
                type="number"
                class="form-control"
                id="motionApprovedThreshold"
                name="approved_threshold_pct"
                min="0"
                max="100"
                step="0.1"
                placeholder="e.g. 50"
                value="50"
              >
              <div class="form-text">Yes must reach this percentage of (Yes + No).</div>
            </div>

            <div class="mb-3" id="scoreMaxGroup">
              <label for="motionScoreMax" class="form-label">
                Max score
              </label>
              <input
                type="number"
                class="form-control"
                id="motionScoreMax"
                name="score_max"
                min="1"
                step="1"
                placeholder="e.g. 10"
                value="10"
              >
              <div class="form-text">Highest score a voter can assign.</div>
            </div>
          </div>

          <div class="modal-footer bg-light border-0">
            <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
            <button type="submit" class="btn btn-primary" id="addMotionSubmit">Add Motion</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Add Voter Modal -->
  <div class="modal fade" id="addVoterModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content border-0 shadow">
        <div class="modal-header bg-light border-0">
          <h5 class="modal-title"><i class="bi bi-person-plus me-2"></i>Add Voter</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>

        <form
          id="addVoterForm"
          method="POST"
          action="{{ url_for('create_voter', meeting_id=meeting.id) }}"
          data-action="{{ url_for('create_voter', meeting_id=meeting.id) }}"
        >
          <div class="modal-body p-3 p-md-4">
            <div class="alert alert-danger d-none" id="addVoterError" role="alert"></div>

            <div class="mb-3">
              <label for="voterName" class="form-label">Voter Name</label>
              <input type="text" class="form-control" id="voterName" name="name" required>
            </div>

            <p class="text-muted mb-0">
              A unique access code will be generated automatically for this voter.
            </p>
          </div>

          <div class="modal-footer bg-light border-0">
            <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
            <button type="submit" class="btn btn-primary" id="addVoterSubmit">Add Voter</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!--Edit Motion Modal-->
  <div class="modal fade" id="editVoterModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content border-0 shadow">
        <div class="modal-header bg-light border-0">
          <h5 class="modal-title"><i class="bi bi-pencil me-2"></i>Edit Voter</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <form id="editVoterForm" method="POST">
          <div class="modal-body p-4">
            <div class="alert alert-danger d-none" id="editVoterError"></div>
            <div class="mb-3">
              <label for="editVoterName" class="form-label">Voter Name</label>
              <input type="text" class="form-control" id="editVoterName" name="name" required>
            </div>
          </div>
          <div class="modal-footer bg-light border-0">
            <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
            <button type="submit" class="btn btn-primary" id="editVoterSubmit">Save Changes</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!--Delete Voter Modal-->
  <div class="modal fade" id="deleteVoterModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content border-0 shadow">
        <div class="modal-header border-0">
          <h5 class="modal-title text-danger"><i class="bi bi-exclamation-triangle me-2"></i>Delete Voter</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          Are you sure you want to delete <strong id="deleteVoterName"></strong>? This action cannot be undone.
        </div>
        <div class="modal-footer border-0">
          <button type="button" class="btn btn-light" data-bs-dismiss="modal">Cancel</button>
          <button type="button" class="btn btn-danger" id="confirmDeleteVoter">Delete Voter</button>
        </div>
      </div>
    </div>
  </div>

  <!--Edit Meeting Details Modal-->
  <div class="modal fade" id="editMeetingModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content border-0 shadow">
        <div class="modal-header bg-light border-0">
          <h5 class="modal-title"><i class="bi bi-pencil-square me-2"></i>Edit Meeting Details</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <form id="editMeetingForm" method="POST" action="{{ url_for('update_meeting', meeting_id=meeting.id) }}">
          <div class="modal-body p-4">
            <div class="mb-3">
              <label for="editMeetingTitle" class="form-label fw-semibold">Meeeting Title</label>
              <input type="text" class="form-control" id="editMeetingTitle" name="title" value="{{ meeting.title }}" required>
            </div>
            <div class="mb-3">
              <label for="editMeetingDescription" class="form-label fw-semibold">Description</label>
              <textarea type="text" class="form-control" id="editMeetingDescription" name="description" value="{{ meeting.description }}" required></textarea>
            </div>
          </div>
          <div class="modal-footer bg-light border-0">
            <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
            <button type="submit" class="btn btn-primary">Save Changes</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!--Edit Motion Modal-->
  <div class="modal fade" id="editMotionModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
      <div class="modal-content border-0 shadow">
        <div class="modal-header bg-light border-0">
          <h5 class="modal-title"><i class="bi bi-pencil-square me-2"></i>Edit Motion</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <form id="editMotionForm" method="POST">
          <div class="modal-body p-3 p-md-4">
            <div class="alert alert-danger d-none" id="editMotionError"></div>

            <div class="mb-3">
              <label for="editMotionTitle" class="form-label">Motion Title</label>
              <input type="text" class="form-control" id="editMotionTitle" name="title" required>
            </div>

            <div class="mb-3">
              <label for="editMotionType" class="form-label">Motion Type</label>
              <select class="form-select" id="editMotionType" name="type" required>
                <option value="YES_NO">Yes / No / Abstain</option>
                <option value="FPTP">First-Past-The-Post (FPTP)</option>
                <option value="PREFERENCE">Preference voting (ranked, multiple winners)</option>
                <option value="SCORE">Score voting</option>
              </select>
            </div>

            <div class="mb-3" id="editCandidatesGroup">
              <label for="editMotionOptions" class="form-label">
                Candidates (one per line)
              </label>
              <textarea
                class="form-control"
                id = "editMotionOptions"
                name="options"
                rows="3"
              ></textarea>
            </div>

            <div class="mb-3" id="editNumWinnersGroup">
              <label for="editMotionNumWinners" class="form-label">
                Number of Winners
              </label>
              <input
                type = "numbers"
                class = "form-control"
                id = "editMotionNumWinners"
                name = "num_winners"
                min="1">
            </div>

            <div class="mb-3" id="editYesNoThresholdGroup">
              <label for="editMotionThreshold" class="form-label">
                Approved threshold (%)
              </label>
              <input
                type="number"
                class="form-control"
                id="editMotionThreshold"
                name="approved_threshold_pct"
                min="0"
                max="100"
                step="0.1"
                placeholder="e.g. 50"
              >
              <div class="form-text">Yes must reach this percentage of (Yes + No).</div>
            </div>

            <div class="mb-3" id="editScoreMaxGroup">
              <label for="editMotionScoreMax" class="form-label">
                Max score
              </label>
              <input
                type="number"
                class="form-control"
                id="editMotionScoreMax"
                name="score_max"
                min="1"
                step="1"
                placeholder="e.g. 10"
              >
              <div class="form-text">Highest score a voter can assign.</div>
            </div>
          <div class="modal-footer bg-light border-0">
            <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
            <button type="submit" class="btn btn-primary" id="editMotionSubmit">Save Changes</button>
          </div>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!--Delete Motion Modal-->
  <div class="modal fade" id="deleteMotionModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content border-0 shadow">
        <div class="modal-header border-0">
          <h5 class="modal-title text-danger"><i class="bi bi-exclamation-triangle me-2"></i>Delete Motion</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          Are you sure you want to delete <strong id="deleteMotionTitleDisplay"></strong>? All votes cast for this motion will be permanently removed.
        </div>
        <div class="modal-footer border-0">
          <button type="button" class="btn btn-light" data-bs-dismiss="modal">Cancel</button>
          <button type="button" class="btn btn-danger" id="confirmDeleteMotion">Delete Motion</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Keep your existing JS exactly (unchanged) -->
  <script>
    window.addEventListener("DOMContentLoaded", function () {
      // Motion modal handling
      const motionModalEl = document.getElementById("addMotionModal");
      const motionForm = document.getElementById("addMotionForm");
      const motionSubmit = document.getElementById("addMotionSubmit");
      const motionError = document.getElementById("addMotionError");
      const motionModal = new bootstrap.Modal(motionModalEl);

      const motionType = document.getElementById("motionType");
      const candidatesGroup = document.getElementById("candidatesGroup");
      const motionCandidates = document.getElementById("motionCandidates");
      const numWinnersGroup = document.getElementById("numWinnersGroup");
      const numWinnersInput = document.getElementById("motionNumWinners");
      const yesNoThresholdGroup = document.getElementById("yesNoThresholdGroup");
      const yesNoThresholdInput = document.getElementById("motionApprovedThreshold");
      const scoreMaxGroup = document.getElementById("scoreMaxGroup");
      const scoreMaxInput = document.getElementById("motionScoreMax");

      function setMotionLoading(isLoading) {
        motionSubmit.disabled = isLoading;
        motionSubmit.innerHTML = isLoading
          ? '<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>Saving...'
          : "Add Motion";
      }

      function updateMotionVisibility() {
        const t = motionType.value;
        const needsCandidates = t !== "YES_NO";

        candidatesGroup.style.display = needsCandidates ? "block" : "none";

        motionCandidates.disabled = !needsCandidates;
        motionCandidates.classList.toggle("bg-light", !needsCandidates);

        const needsNumWinners = t === "PREFERENCE";
        numWinnersGroup.style.display = needsNumWinners ? "block" : "none";
        const needsThreshold = t === "YES_NO";
        yesNoThresholdGroup.style.display = needsThreshold ? "block" : "none";
        yesNoThresholdInput.disabled = !needsThreshold;
        const needsScoreMax = t === "SCORE";
        scoreMaxGroup.style.display = needsScoreMax ? "block" : "none";
        scoreMaxInput.disabled = !needsScoreMax;

        if (!needsCandidates) {
          document.getElementById("motionCandidates").value = "";
        }
        if (!needsNumWinners) {
          numWinnersInput.value = "";
        }
        if (!needsThreshold) {
          yesNoThresholdInput.value = "";
        } else if (!yesNoThresholdInput.value) {
          yesNoThresholdInput.value = "50";
        }
        if (!needsScoreMax) {
          scoreMaxInput.value = "";
        } else if (!scoreMaxInput.value) {
          scoreMaxInput.value = "10";
        }
      }

      motionType.addEventListener("change", updateMotionVisibility);
      updateMotionVisibility();

      motionForm.addEventListener("submit", async (event) => {
        event.preventDefault();
        setMotionLoading(true);
        motionError.classList.add("d-none");

        const formData = new FormData(motionForm);
        try {
          const response = await fetch(motionForm.dataset.action, {
            method: "POST",
            body: formData,
            headers: { "X-Requested-With": "XMLHttpRequest" },
          });

          if (!response.ok) {
            let message = "Failed to add motion.";
            try {
              const data = await response.json();
              if (data && data.error) message = data.error;
            } catch (err) { /* ignore parse errors */ }
            throw new Error(message);
          }

          motionModal.hide();
          try {
            sessionStorage.setItem("vpFlash", JSON.stringify({
              type: "success",
              message: "Motion added successfully."
            }));
          } catch (e) { /* ignore */ }
          window.location.reload();
        } catch (err) {
          motionError.textContent = err.message;
          motionError.classList.remove("d-none");
        } finally {
          setMotionLoading(false);
        }
      });

      motionModalEl.addEventListener("hidden.bs.modal", () => {
        motionForm.reset();
        updateMotionVisibility();
        motionError.classList.add("d-none");
        setMotionLoading(false);
      });

      // Voter modal handling
      const voterModalEl = document.getElementById("addVoterModal");
      const voterForm = document.getElementById("addVoterForm");
      const voterSubmit = document.getElementById("addVoterSubmit");
      const voterError = document.getElementById("addVoterError");
      const voterModal = new bootstrap.Modal(voterModalEl);

      function setVoterLoading(isLoading) {
        voterSubmit.disabled = isLoading;
        voterSubmit.innerHTML = isLoading
          ? '<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>Saving...'
          : "Add Voter";
      }

      voterForm.addEventListener("submit", async (event) => {
        event.preventDefault();
        setVoterLoading(true);
        voterError.classList.add("d-none");

        const formData = new FormData(voterForm);
        try {
          const response = await fetch(voterForm.dataset.action, {
            method: "POST",
            body: formData,
            headers: { "X-Requested-With": "XMLHttpRequest" },
          });

          if (!response.ok) {
            let message = "Failed to add voter.";
            try {
              const data = await response.json();
              if (data && data.error) message = data.error;
            } catch (err) { /* ignore parse errors */ }
            throw new Error(message);
          }

          voterModal.hide();
          try {
            sessionStorage.setItem("vpFlash", JSON.stringify({
              type: "success",
              message: "Voter added successfully."
            }));
          } catch (e) { /* ignore */ }
          window.location.reload();
        } catch (err) {
          voterError.textContent = err.message;
          voterError.classList.remove("d-none");
        } finally {
          setVoterLoading(false);
        }
      });

      voterModalEl.addEventListener("hidden.bs.modal", () => {
        voterForm.reset();
        voterError.classList.add("d-none");
        setVoterLoading(false);
      });

      // --- Edit and Delete Voter Logic ---
      const editVoterModal = new bootstrap.Modal(document.getElementById('editVoterModal'));
      const deleteVoterModal = new bootstrap.Modal(document.getElementById('deleteVoterModal'));
      let currentVoterId = null;

      // Open Edit Modal
      document.querySelectorAll('.edit-voter-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          currentVoterId = btn.dataset.voterId;
          document.getElementById('editVoterName').value = btn.dataset.voterName;
          editVoterModal.show();
        });
      });

      // Submit Edit
      document.getElementById('editVoterForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const name = document.getElementById('editVoterName').value;
        // Assumes a route like /admin/voter/<id>/update
        const url = `/admin/voter/${currentVoterId}/update`; 
        
        try {
          const response = await fetch(url, {
            method: 'POST',
            body: new FormData(e.target),
            headers: { "X-Requested-With": "XMLHttpRequest" }
          });
          if (response.ok) window.location.reload();
          else alert("Failed to update voter");
        } catch (err) { console.error(err); }
      });

      // Open Delete Modal
      document.querySelectorAll('.delete-voter-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          currentVoterId = btn.dataset.voterId;
          document.getElementById('deleteVoterName').textContent = btn.dataset.voterName;
          deleteVoterModal.show();
        });
      });

      // Copy voter link
      document.querySelectorAll('.copy-voter-link-btn').forEach(btn => {
        btn.addEventListener('click', async () => {
          const link = btn.dataset.voterLink;
          try {
            await navigator.clipboard.writeText(link);
            if (typeof showFlashModal === "function") {
              showFlashModal("success", "Voter link copied.");
            }
          } catch (err) {
            if (typeof showFlashModal === "function") {
              showFlashModal("danger", "Failed to copy link.");
            }
          }
        });
      });

      // Confirm Delete
      document.getElementById('confirmDeleteVoter').addEventListener('click', async () => {
        // Assumes a route like /admin/voter/<id>/delete
        const url = `/admin/voter/${currentVoterId}/delete`;
        
        try {
          const response = await fetch(url, { 
            method: 'POST',
            headers: { "X-Requested-With": "XMLHttpRequest" } 
          });
          if (response.ok) window.location.reload();
          else alert("Failed to delete voter");
        } catch (err) { console.error(err); }
      });

      // --- Edit and Delete Motion Logic ---
      const editMotionModal = new bootstrap.Modal(document.getElementById('editMotionModal'));
      const editTypeSelect = document.getElementById("editMotionType");
      const editCandidatesGroup = document.getElementById("editCandidatesGroup");
      const editOptionsText = document.getElementById("editMotionOptions");
      const editWinnersGroup = document.getElementById("editNumWinnersGroup");
      const editThresholdGroup = document.getElementById("editYesNoThresholdGroup");
      const editThresholdInput = document.getElementById("editMotionThreshold");
      const editScoreMaxGroup = document.getElementById("editScoreMaxGroup");
      const editScoreMaxInput = document.getElementById("editMotionScoreMax");

      const deleteMotionModal = new bootstrap.Modal(document.getElementById('deleteMotionModal'));
      let currentMotionId = null;

      function updateEditVisibility() {
        const t = editTypeSelect.value;
        const needsCandidates = t !== "YES_NO";

        editCandidatesGroup.style.display = needsCandidates ? "block" : "none";
        
        editOptionsText.disabled = !needsCandidates;
        editOptionsText.classList.toggle("bg-light", !needsCandidates);
        editWinnersGroup.style.display = (t === "PREFERENCE") ? "block" : "none";
        editThresholdGroup.style.display = (t === "YES_NO") ? "block" : "none";
        editThresholdInput.disabled = t !== "YES_NO";
        editScoreMaxGroup.style.display = (t === "SCORE") ? "block" : "none";
        editScoreMaxInput.disabled = t !== "SCORE";

        if (t !== "YES_NO") {
          editThresholdInput.value = "";
        } else if (!editThresholdInput.value) {
          editThresholdInput.value = "50";
        }

        if (t !== "SCORE") {
          editScoreMaxInput.value = "";
        } else if (!editScoreMaxInput.value) {
          editScoreMaxInput.value = "10";
        }
      }

      editTypeSelect.addEventListener("change", updateEditVisibility);

      document.querySelectorAll('.edit-motion-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          currentMotionId = btn.dataset.motionId;
          document.getElementById('editMotionTitle').value = btn.dataset.motionTitle;
          editTypeSelect.value = btn.dataset.motionType;
          editOptionsText.value = btn.dataset.motionOptions;
          // set status
          var statusSelect = document.getElementById('editMotionStatus');
          if (statusSelect && btn.dataset.motionStatus) {
            statusSelect.value = btn.dataset.motionStatus;
          }
          document.getElementById('editMotionNumWinners').value = btn.dataset.motionWinners;
          editThresholdInput.value = btn.dataset.motionThreshold || "50";
          editScoreMaxInput.value = btn.dataset.motionScoreMax || "10";
          
          updateEditVisibility();
          editMotionModal.show();
        });
      });

      // Submit Edit Motion Form
      document.getElementById('editMotionForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const formData = new FormData(e.target);
        const url = `/admin/motion/${currentMotionId}/update`; 
        
        try {
          const response = await fetch(url, {
            method: 'POST',
            body: formData,
            headers: { "X-Requested-With": "XMLHttpRequest" }
          });
          if (response.ok) window.location.reload();
          else alert("Failed to update motion title.");
        } catch (err) { console.error(err); }
      });

      // Open Delete Motion Modal
      document.querySelectorAll('.delete-motion-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          currentMotionId = btn.dataset.motionId;
          document.getElementById('deleteMotionTitleDisplay').textContent = btn.dataset.motionTitle;
          console.log(btn.dataset.motionTitle);
          console.log(111111);
          deleteMotionModal.show();
          console.log(22222);
        });
      });

      // Confirm Delete Motion
      document.getElementById('confirmDeleteMotion').addEventListener('click', async () => {
        const url = `/admin/motion/${currentMotionId}/delete`;
        
        try {
          const response = await fetch(url, { 
            method: 'POST',
            headers: { "X-Requested-With": "XMLHttpRequest" } 
          });
          if (response.ok) window.location.reload();
          else alert("Failed to delete motion.");
        } catch (err) { console.error(err); }
      });
    });
  </script>

  <style>
    .scrollable-panel {
      max-height: 400px;
      overflow-y: auto;
    }
  </style>
{% endblock %}
