{% extends "base.html" %}

{% block content %}
  <div class="py-4">
    <a href="{{ url_for('meeting_detail', meeting_id=meeting.id) }}" class="btn btn-link">
      &larr; Back to meeting
    </a>

    <h1 class="mb-1">Results – {{ meeting.title }}</h1>
    <p class="text-muted mb-4">
      Meeting ID: {{ meeting.id }}
    </p>

    {% if results %}
      {% for item in results %}
        {% set motion = item.motion %}
        <div class="card mb-4">
          <div class="card-body">
            <h2 class="h5 card-title mb-1">{{ motion.title }}</h2>
            <p class="text-muted mb-3">
              Type: {{ motion.type }} &middot; Status: {{ motion.status }}
            </p>

            {% if item.is_preference %}
              {% set pref = item.pref %}
              <p class="mb-2">
                Preference ballots: {{ pref.total_ballots }}<br>
                Number of winners: {{ pref.num_winners }}<br>
                Winners (in order):
                {% if pref.winners %}
                  {% for w in pref.winners %}
                    <span class="badge bg-success">{{ w.text }}</span>
                  {% endfor %}
                {% else %}
                  <span class="text-muted">No winners determined.</span>
                {% endif %}
              </p>

              {% for seat in pref.seats %}
                <h3 class="h6 mt-3 mb-2">Seat {{ seat.seat_number }} – Winner: {{ seat.winner.text }}</h3>
                <table class="table table-sm align-middle mb-3">
                  <thead>
                    <tr>
                      <th>Round</th>
                      <th>Candidate</th>
                      <th>Votes</th>
                    </tr>
                  </thead>
                  <tbody>
                    {% for round in seat.rounds %}
                      {% for row in round.counts %}
                        <tr>
                          <td>{{ round.round_number }}</td>
                          <td>
                            {{ row.option.text }}
                            {% if row.option.id == seat.winner.id %}
                              <span class="badge bg-success ms-1">Elected</span>
                            {% endif %}
                          </td>
                          <td>{{ row.count }}</td>
                        </tr>
                      {% endfor %}
                    {% endfor %}
                  </tbody>
                </table>
                {% if seat.round_logs %}
                  <div class="mt-2">
                    <h4 class="h6">Round-by-round summary</h4>
                      <ol class="mb-0">
                        {% for round_log in seat.round_logs %}
                          <li class="mb-1">
                            {% for line in round_log %}
                              <div>{{ line }}</div>
                            {% endfor %}
                          </li>
                        {% endfor %}
                      </ol>
                    </div>
                {% endif %}

              {% endfor %}
            {% endif %}
          </div>
        </div>
      {% endfor %}

    {% else %}
      <div class="alert alert-info">
        There are no motions configured for this meeting yet.
      </div>
    {% endif %}
  </div>
{% endblock %}
